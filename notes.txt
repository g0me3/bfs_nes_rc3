
НОВЫЕ БАГИ

* Заблокировать убийство нинзя большим "Бумом", иначе можно попасть в вечное ожидание в концовке.

* При каких-то обстоятельствах счетчик до начала стрельбы пушки в 3 уровне уходит в левые значения и пушка не стреляет, пока он не прокрутится до нуля.

СТАРЫЕ БАГИ

* Самый известный и раздражающий "баг" - это прерывание музыки при сменах экранов на титульнике. Происходит это частично из-за того, что функция проигрывания рассована по разным местам циклов событий, а не один раз в конце NMI (хотя видимо это было сделано, чтобы не решать проблему коллизий при смене банков). Но в основном из-за того, что на смену экрана требуется довольно много времени, во время которого NMI тоже отключаются, так что лаги бы не пропали.

* Управление пропуском экранов геймовера и концовки, включая экран ввода имени в таблицу очков выполнено на основе таймеров, то есть вместо того, чтобы по нажатию кнопки прыгать на нужную ветку кода или пропускать ненужную, изменяется параметр таймера и программа начинает ходить по другим веткам сама, возможно это сделано для переинициализации таймеров титула перед его рестартом, возможно по какой-то другой не совсем явной причине. Но работает это из рук вон плоховато. Экран очков может скипануться сразу же после попадания в него, а титульник перескочить сразу на начало игры, либо сразу с геймовера в игру через два экрана.

* В последнем уровне при истечении таймера происходит немедленный гамовер без каких бы то ни было сообщений. Между тем, перед выходом программа устанавливает запрос на отображение сообщения с индексом 0х1А в строке состояния. В таблице указателей последний индекс - 0х19. Но в блоке текстовых сообщений в самом конце имеется неиспользованная строчка "OUT OF TIME". Очевидно, этот баг просмотрели и если бы не происходил немедленный выход, игру бы сглючивало.

ИСПРАВЛЕННЫЕ СТАРЫЕ БАГИ

* Один из безобидных багов проявляется, если начать игру без музыки. Во время, когда на экране появляется враг-ниндзя, музыка начинает играть вновь, а после убийства ниндзи восстанавливается музыка уровня до начала следующего. Персонаж нинзи в своем хендле автоматически меняет муз сопровождение на специальное, и вызывает функцию старта музыки, которая как и положено НЕ запускается, если она погашена. Но, переменная, которой присваивается значение мелодии, используется и при старте звуков, а функция для их старта вызывается постоянно в основном цикле программы, так что после неудачной попытки запустить музыку, она запускается через старт звуков, так как индекс ненулевой и не чистится никем до того времени. Теперь процедура проигрывания стирает форсом переменную, если тот или иной канал отключен.

* Переменная позиции меню титульного экрана после гамовера встает на "КОНТИНУЕ" автоматически, если есть продолжения. Но больше нигде кроме гамовера не инициализируется, так что если в процессе игры получить гамовер, но потом ее пройти, титульное меню встанет все равно на континуе.

* Спрайты для дорисовки живота РобоКопа на титульнике выброшены, так как конфликтуют со спрайтами меню. Требуется переработка фотмата меню, чтобы вернуть их назад, а также поправить палитру для этого спрайта.

* По всей видимости мало кто обращал внимание, что при переходе на пятый уровень после уничтожения ходячего робота количество очков, набранное в текущем уровне сбрасывается до уровня предыдущего, которое было сохранено предварительно перед окончанием третьего. Если в четвертом уровне получить геймовер, при попадании к ниндзя очков станет, естественно, ноль. Одновременно это влечет также восстановление параметров игрока на момент четвертого уровня, то есть пропадет результат ремонта в конце четвертого, но восстановится здоровье до момента его начала.

* При первом появлении робокопа на уровне возле головы вспыхивает и пропадает облачко взрыва, хотя дамажа не отмечается. Происходит потому, что функция расчета общего состояния и инициализация переменной происходят позже, чем проверка на необходимость рисовать анимацию взрыва. этого хватает, чтобы на первом кадре добавился объект взрыва. На втором кадре переменная инициализируется и взрыв останавливается.

* На экране ремонтной лаборатории два последних спрайта из состава оверлея перезаписываются поверх спрайтом ремонтного элемента, от чего пропадает кусок платформы под правой ногой робокопа.

* Звездное поле на первом запуске после титульника стартует в неинициализированном виде, с нулей, но так как в самой процедуре есть автоматическая генерация новых звезд, это заметно только в первые секунды начала анимации, когда поле совершенно пустое и летит одна звездочка, но потом вылетают все остальные. В двух других местах игры перед показом звездного поля, все 20 звезд генерятся предварительно.

* Отображение количества ремонтных контейнеров использует только 1 символ, если число больше 9, предусмотрено отображение одиночного символа. Но по тем или иным причинам, этот символ - знак процента, а не 9. В игре, к дающимся изначально пяти контейнерам, дополнительно можно собрать еще 6, так что получаем

* В последнем уровне таймер времени отображает минуты и секунды отдельно через пробел, но в коде игры между двумя цифрами ставится ненулевой индекс тайла, который, тем не менее, не имеет графики. Подразумевалось, что здесь будет двоеточие, но оно не было нарисовано по тем или иным причинам. Двоеточие дорисовано, таймер сдвинут влево на два символа.

ИЗМЕНЕНИЯ

* Как обычно чистка, избавление от ненужного кода, удаление дубликатов процедур.

* Все вызовы проигрывания музыки убраны из неигровых обработчиков и циклов и внесены один раз в обработчик NMI. Должно быть достаточно безопасно, пока весь неигровой код находится исключительно в банке 5.

* В игре есть две одинаковых функции конвертирования 16-битного 16-ричного числа в пять десятичных в буфере. Одна находится и используется в банке 5, другая - в 7. Причем код обеих процедур довольно универсальный и может использоваться в обоих банках одинаково.

* Заменил разрозненные оверлейные спрайты на разных экранах единой процедурой и форматом данных. Спрайты с логотипов перенесены в тайловые карты и убраны из патчей. Также убрал лишние ветки для вставки нулевого спрайта, теперь они задаются теми же общими оверлеями.

* Копирайтный экран почему-то рисовался с помощью процедуры рисования БИОС от брифинга перед игрой. Для этого даже специально добавили пустое сообщение в таблицу. Текст копирайтов впечатывался поверх нарисованного, и если не стереть заголовок биоса, остается левый текста между строк. Ребята это тупо исправили забиванием отдельно пустой строки в тексте копирайтов. Убрал это из них, поменял процедуру вывода текста БИОС на просто рисование стандартного окна.

* Кодировка неигровой части текстов приведена к одному типу, теперь интро перед стартом игры и все игровые брифинги и копирайты в одной кодировке, так что можно использовать одну общую функцию вывода и убрать коррекции индексов тайлов.

* Добавлено звездное поле на экране копирайтов.

* В списке сообщений есть одно под индексом "убирайся отсюда". Видимо предназначалось для финального брифинга в конце уровня, но по каким-то причинам так и не было использовано.

* Расширен алфавит для ввода имени, теперь можно ввести точку и цифры.

* Удален код для хранения параметров двух игроков, изменена логика инициализации игрока перед стартом, после континуя, после концовки. Параметры игрока инициализируются на старте, после геймовера стирается только текущее оружие и очки.

* На старте игры нельзя начать уровень сразу с континуя, континуй включается только после начала новой игры или продолжения старой, также континуй не распространяется на первый уровень.

* Проверка на отказ сделана по живому по текущим значениям процентов энергии, то есть может меняться в зависимости от состояния на уровне, при получении урона ухудшаться, при лечении улучшаться.

* Потеря оружия между уровнями при нормальном прохождении отключена. Все патроны и собранные бомбы сохраняются. Теперь есть возможность при сборе дополнительных поверапов восстанавливать патроны обычного оружия (не ракеты), если поверапаться уже некуда (а также мочить нинзей во втором уровне большим взрывом).

* Слегка усложнен порядок подсчета урона и общего состояния робокопа. Введен максимум на процент каждой части тела 100%, но сумма общей защиты достигает максимума 200%. Внутренние параметры защиты и урона скорректированы соответственно. В целом уровень сложности не должен измениться, только разнесены вполовину диапазона уровни начального значения энергии и минимального порога отказа, чтобы из-за пересчета отказа в реальном времени, он не начинал случаться сразу же после начала игры.

* Добавлены две отключенные версии звуков поднятия призов для режима игры без музыки. С музыкой звуки остались прежние, так как новые используют тот же второй канал и стопорят фоновую музыку.

* Переделана система ввода ингейма, а также система блокировки при ошибке. Некоторые места стали проще для проверки.

* Система ввода внеигровых ивентов совмещена с общей ингеймовской, весь код переделан под нее. Больше никаких паразитных нажатий, дикой логики запоминания предыдущего нажатия в двух разных переменных и т.п. Как следствие, заработал пропуск таблицы рекордов, который из-за бага в исходном коде не опрашивался.

* Привел к ощей системе задержки для рендера и эффекта разделения экрана.

ВНУТРЯНКА

* В звуковых данных есть несколько неиспользуемых звуковых семплов. В выложенных ранних сорсах звукового движка можно найти только первые два с индексами $0Е и $10. Это вторые половины звуков поднятия призов, предназначенные для второго канала звукового чипа. Но так как в игре второй канал используется исключительно для проигрывания фоновой мелодии, эти семплы просто выброшены. В коментариях Ж.Тел предупреждает программиста Г.Харрисона, что играть этот семпл, если включена музка, нельзя. Видимо тот, чтобы не решать проблему коллизий звуковых дорожек, просто решил их отключить насовсем.

* В игре как минимум три разных дефолтных таблицы рекордов. Одна используется на старте, одна врисована в дефолтную тайловую карту экрана таблицы рекордов (в ней есть неизвстное имя, повторенное 4 раза) и одна совершенно неиспользованная. В последней имена разработчиков такие же, только 6 и 4 поменяны местами и другие очки игроков с максимум в более чем миллион.

* Игра изначально планировалась для двух игроков поочереди на одном контроллере, от этого остались внутренний индекс текущего игрока, бекапы параметров игроков в отдельный архивный массив и выборка их перед новым уровнем. Хотя инитится оба бекапа, индекс игрока в игре никогда не меняется и всегда выбирается только нулевой. В некоторых случаях игра выбирает переменные форсом без учета текущего игрока, как например продолжения - она считает их только у первого игрока, одновременно переменная бекапа континуя для первого игрока работает как глобальная переменная текущего количества континуев и не переписывается в отдельную переменную, как все другие параметры.

* Дефолтная тайловая карта строки состояния игрока содержит строку текста, которая никогда не отображается в игре, так как сразу же затирается другими сообщениями: "A SAMPLE MESSAGE".

* Перед стартом уровня один раз рассчитывается порог отказа четырех подсистем персонажа, исходя из текущих процентов защиты после починки или продолжения игры. Каждая подсистема с процентом ниже 18 становится потенциальным источником сбоев. Если какой-то из параметров упал ниже уровня во время игры, это не влияет на появление отказов. Отказ той или иной системы персонажа во время игры рассчитывается раз в 100 кадров (примерно раз в 1.5 секунды). Случайным  образом выбирается одна из четырех подсистем и проверяется порог ее отказа. В случае превышения порога, с вероятностью 0.2 выбранной подсистеме выставляется флаг отказа. Если система была в отказе, а очередная проверка на отказ дала отрицательный результат, система восстанавливается с сообщением "ЗАЩИЩАТЬ НЕВИНОВНЫХ". Таким образом каждый отдельный цикл отказа может продолжаться не более 1.5 секунды, но может быть возобновлен на следующие 1.5 секунды или заменен отказом другой.

* В банке графики строки состояния практически нет пустого места. Между тем, там сидят целых четыре разных набора символов для отображения цифр, причем два предназначены для строки сообщений. Ни один из этих двух наборов в игре не используется, так как все сообщения цифр не содержат. При необходимости увеличения количества оружия, можно убрать эти ненужные цифры, на крайний случай оставить только один из них и возможно добавить какие-то сообщения, их использующие.

* Когда игрок встает на транспортер о втором уровне и тот его несет вперед, при достижении середины экрана вместе с перемещением автоматически включается скролл и скроллит персонажа вместе с экраном, также, как и при обычном перемещении, за это отвечает отдельная ветка в процедуре перемещения на транспортере. В ней же есть отдельная проверка, которая проверяет, не находится ли персонаж в самом конце уровня, стоя на транспортере, если да, то автоскролл пропускается. Таким образом производится своего рода защита уровня от лишнего скролла, так как сам по себе он сделан костылем поверх движка. Но в конце уровня в финальной версии нет достаточно длинного транспортера, чтобы сработала данная защитная ветка, остаток уровня все равно приходится идти ногами и там уже скролл блокируется движком автоматически. По всей видимости, на этапе разработки транспортер был длиннее и сначала сделали такую вот проверку, но потом просто решили укоротить транспортер. Возможно ветка оставлена по соображениям дальнейших возможных изменений уровня, когда транспортер опять может появиться.

* Пламя от ракетного сопла в третьем уровне у робокопа странно подглючивает. При перемещении горизонтально оно может не только смещаться вправо-влево от нормального значения, но и отделяться от ранца, показывая дыру между ним и пламенем.

* В ремонтной лаборатории некоторые тайлы графики не используются в финальной версии, хотя тайловые карты присутствуют. Тайловые карты оверлеев для рисования повреждений ног имеют размер 8х6, но используются только 8х5. Если сравнить полный вариант с неполным, видно, что большая часть тайлов в этом оверлее совпадает с изначальной тайловой картой без повреждений, а его нижняя последняя строка отличается только в одном последнем кадре при максимальном повреждении. Но основной причиной отключения этой лишней строки является, скорее всего, то, что сам оверлей своей последней строкой затирает один из тайлов неменяющейся части картинки (вертикальную полосу, видно на скриншотах при сравнении), этого можно было бы избежать при изменении формата данных для вывода на экран и соответственно процедур, но так как, судя по всему, игра разрабатывалась довольно быстро, формат простынки кода для вывода графики этого не позволял сделать без дополнительных усилий. Так что исправлен этот глюк был простым отключением части кода, рисовавшего последнуюю строку оверлея. Код до сих пор присутствует в ПЗУ игры. Совершенно неиспользованным остался отдельный третий оверлей повреждений левой руки игрока. В текущей версии их используется два: заменяется целиком предплечье правой руки и небольшой участок предплечья левой. Третий должен был рисовать повреждение кисти левой руки и состоять из битмапов 4х4. Причин неиспользования может быть несколько. Во-первых, сам оверлей 4х4 имеет совершенно пустую нижнюю строку, которая бы точно затирала часть исходной тайловой карты, но даже если ее не использовать, что несложно, на экране повреждения кисти выглядят неестественно и довольно странно, так как все остальные конечности так не повреждаются. По всей видимости данный оверлей решено было не использовать еще на ранней стадии разработки, а код, если он даже и был, совершенно удалить из ПЗУ по причине того, что он занимал бы слишком много места.

* Некоторые статичные экраны в игре имеют спрайтовый патч для увеличения диапазона отображаемых цветов. Процедура рисования законченного экрана хранит таблицу таких патчей. В отличие от запакованных тайловых карт, патч спрайта - это практически пустой битмап 32х27, где ненулевыми индексами обозначен второй слой картинки, который и преобразуется в спрайты программно. На один такой битмап уходит 864 байта. Всего их должно быть три, но для экрана концовки игры просто не хватило места, патчи этого экрана пишутся напрямую опкодами в спрайтовый буфер в процедуре инициализации рисования. Судя по всему у ребят было так мало времени, что они даже не успели сконвертировать эти патчи во что-то более простое, например в голые спрайтовые данные, либо не было времени писать для этого отдельные инструменты, а проще было дописать процедурку для конвертирования на лету в программе.

* В отличие от прочих игр без прерываний, использующих для разделения игрового экрана и строки состояния спрайт0 хит, в этой он используется для разделения банков графики между двумя половинами игрового поля, позволяя расширить число уникальных объектов на экране одновременно. При этом игровой экран отделяется на простой тайминговой основе. После прихода NMI производятся как можно быстрее добавление немногочисленных ппу данных из наработанных буферов за время обратного хода луча, включается рендер, а затем просто ожидается некоторое время, за которое рендер успевает пройти первые 60-70 строк растра, нарисовав HUD. Затем идет переключение банка игровой графики и скроллов и игра отпускается в свободное плаванье. Чтобы успевать вывести всю графику за время обратного хода луча, рисование разделено на этапы, по одному за кадр, вместо того, чтобы делать это сразу за раз. Причем время выполнения отдельных процедур подогнано по таймингу друг под друга, если какая-то функция выполняется быстрее, в конце ее стоит руками подобранная задержка, чтобы время выполнения было примерно одинаковым. Из-за этого из примерно 30000 тиков на кадр основной программе достается около 22000, а 8000 NMI проводит в ожидании конца отрисовки HUD.

* Если исходить из того, что в режиме ремонта можно поставить курсор, как на правую, так и на левую руки, а экран приближения отдельно прописывает, какая рука левая, а какая правая на одном экране, а также большое количество доп изменяющейся графики для левой руки, которая больше не используется, можно предположить, что левая и правые руки должны были получать урон раздельно и чиниться раздельно. Но по той или иной причине от этой идеи было решено отказаться, но вымарывать до конца все свидетельства этого почему-то не стали. Хотя бОльшая часть кода удалена, либо изначально не была запрограммирована, так как нет ни одной лишей переменной или зазора в списках переменных урона разных частей тела. Вполне возможно графика урова левой руки была вымарана не по причине того, что она плохо выглядит, а просто потому что ее решили не портить (тем более стреляет робокоп обычно правой, левая по логике должна всегда страдать меньше;)

* Если собрать третий поверап оружия конкретного типа, то вместо усиления энергии должны быть полностью восстановлены патроны всех видов оружия этого типа. Но на уровнях нет столько поверапов за раз, так что эта ветка никогда не срабатывает.

* Количество энергии и эффективность Робокопа оценивается по 8-битной циклической суме процентов защиты. Это подразумевает теоретическую ситуацию, когда сумма ненулевых процентов защиты становится нулем с переполнением и персонаж взрывается. Требуется проверка практической возможности такого варианта в игре. Скорее всего в игре не проявляется.

* Кажется, что интеллект врагов написан хреново или дизайн игры не продуман, но судя по количеству кода, который отвечает за поведение простого врага с пистолетом, это все было придумано специально или, как минимум, было отполировано под общую кривую модель поведения. Например, враги набегают на Робокопа и стараются к нему приблизиться, а потом бегают туда-сюда в непосредственной близости, иногда их корежит в обе стороны попеременно. Но, в коде есть специальная ветка, проверяющая, не приблизился ли враг на определенное расстояние со спины робокопа и не стрельнул ли! Если все совпало, робокоп получает небольшой урон в ноги, без выстрела как такового. Если бы этой ветки не было, враг бы просто стрелял сквозь Робокопа. Это не работает со стороны лица, тем не менее, что говорит о сознательном выборе урона именно со спины.

* Логика окончания уровня в определенных местах подразумевает досрочный выход из подпрограмм в основной цикл. В этом случае делается очистка стека, чтобы вернуться сразу на нужный уровень кода. Но фактически это ни к чему не обязывает, так как страница стека вообще никак не используется, даже если она переполнится, она начнется сначала без каких бы то ни было последствий, контроля стека в игре нет. Единственный побочный эффект заключается в том, что после каждого пройденного уровня, указатель стека уплывает на два байта. Практически в текущей версии игры это не может привести ни к каким проблемам, но теоретически, при необходимости использовать страницу стека под переменные, это могло бы повлечь ошибки порчи данных.

ПРОЧЕЕ

* Все движки Джероен Тела во всех играх практически одинаковы, соответственно одинаковы форматы музыки и данных. Имеются сорсы на звуковые движки игр Beauty and the Beast, Bram Stoker's Dracula, Overlord, Robocop 3, Technocop, по ним можно проследить, как они менялись и какая разница между финальной версией и сорсами. Для игр Alien 3 (какие еще?) сорсов нет, но движок идентичный. Движки слегка отличаются друг от друга, одни и те же места в одних версиях могут быть закомментированы, в других нет. Все они довольно примитивны в плане невозможности микширования или проигрывания нескольких семплов на одном канале. До кучи недостаток структуры движка в том, что ссылки на таблицы амплитуд, фиксированные инструменты, секвенсы фиксированные и не позволяют простое добавление данных музыки друг к другу. Даже в исходных сорсах вместо мнемонических используются цифровые индексы разных параметров, новые элементы можно добавлять только добавлением в конец, а перенести другие данные из другого движка без перенумерации последовательностей и других параметров невозможно.

* В сорсах звука недоделанной игры Технокоп несколько разных сорсов разной степени законченности для ПАЛ и НТСЦ регионов, но даже там структура движка дает о себе знать. Чтобы совместить в одном демо проигрывателе музыку разных кусков игры автору пришлось дублировать код на две одинаковых ветки, каждая из которых играет по своим таблицам данных свою собственную музыку. Это все, конечно, печально. В более ранних игрушках японцы делали более продвинутые секвенсеры, позволявшие играть музыку и звуки одновременно без мучений с разделением каналов и т.п.

* Довольно сильно по структуре данных от других отличается движок Бьюти энд зе Бист. Там очень много семплов и музыки, пришлось их разделить на два разных банка, и проверять в коде по индексу семпла, какому банку они принадлежат. Но тем не менее, дальше проигрыватель просто имеет два одинаковых куска кода, вычитывающих только разные таблицы, но делающих абсолютно одинаковую работу. Дополнительно там перепедалены таблицы сиквенсов и скоростей и изменен формат скорости.

* В Технокопе же была сделана попытка использовать ДМЦ канал и даже есть тестовый трек, но хоть он и прописан в таблицах, в проигрывателе отключен вызов функции старта мелодии и семплы закоментированы. Непонятно, был бы трек доделан или так и не был окончен, основная драм линия кажется попадает в тему, но в целом звучит местами странно.

* Данный движок используется и на других системах, так что принципиально путем переноса только данных можно переносить музыку между разными системами. Правда, по крайней мере на ГеймБой практически нет интересных игр и мелодий, чтобы это было оправдано сделать.
